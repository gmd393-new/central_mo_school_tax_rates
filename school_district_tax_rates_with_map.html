<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaflet + D3: School Districts</title>

  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>

  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    /* Containers for map & chart, side by side */
    #map {
      width: 50%;
      height: 600px;
      float: left;
    }
    #chart {
      width: 50%;
      height: 600px;
      float: right;
      overflow-y: auto; /* scroll if the chart is too tall */
      padding: 10px;
      box-sizing: border-box;
    }

    /* Bar styles */
    .bar {
      fill: steelblue;
    }
    .bar:hover {
      fill: orange;
    }
    .highlighted {
      fill: orange;
      stroke: #444;
      stroke-width: 2px;
    }

    /* Leaflet polygon highlight (when we hover or highlight) */
    .leaflet-interactive { /* baseline for polygons that can be interacted with */
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Leaflet map container -->
  <div id="map"></div>

  <!-- D3 chart container -->
  <div id="chart"></div>

<script>
    //////////////////////////////////////////////////////////////////
    // 1) Initialize Leaflet Map & Add Basemap
    //////////////////////////////////////////////////////////////////
    const map = L.map("map").setView([38.5767, -92.1735], 7); 
    // Center roughly on Missouri, zoom ~7

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    }).addTo(map);

    //////////////////////////////////////////////////////////////////
    // 2) Prepare the D3 Bar Chart
    //////////////////////////////////////////////////////////////////

    let taxData = [];

    // Fetch the JSON file containing your array of objects
    fetch("taxData.json")  // <-- path to your external JSON
    .then(response => response.json())
    .then(data => {
            taxData = data;

            // Sort data ascending by tax
            taxData.sort((a, b) => d3.ascending(a.tax, b.tax));

            // Chart dimensions
            const chartWidth = 480,
                        chartHeight = 600,
                        margin = { top: 20, right: 20, bottom: 20, left: 150 };

            // Create scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(taxData, d => d.tax)])
                .range([0, chartWidth - margin.left - margin.right]);

            const y = d3.scaleBand()
                .domain(taxData.map(d => d.name))
                .range([0, chartHeight - margin.top - margin.bottom])
                .padding(0.1);

            // Create SVG in #chart
            const svgChart = d3.select("#chart")
                .append("svg")
                .attr("width", chartWidth)
                .attr("height", chartHeight);

            // Chart group
            const chartGroup = svgChart.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // Bars
            chartGroup.selectAll(".bar")
                .data(taxData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("y", d => y(d.name))
                .attr("height", y.bandwidth())
                .attr("x", 0)
                .attr("width", d => x(d.tax))
                .on("mouseover", function(event, d) {
                    d3.select(this).classed("highlighted", true);
                    highlightDistrictOnMap(d.name, true);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).classed("highlighted", false);
                    highlightDistrictOnMap(d.name, false);
                })
                .on("click", function(event, d) {
                    // If you want a click action on the bar
                });

            // Y-axis (district names)
            chartGroup.append("g")
                .call(d3.axisLeft(y));

            // X-axis (tax scale, with $ formatting if you want)
            chartGroup.append("g")
                .attr("transform", `translate(0, ${chartHeight - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).tickFormat(d => `$${d.toFixed(2)}`));
    })
    .catch(err => console.error("Error loading taxData.json:", err));

    

    //////////////////////////////////////////////////////////////////
    // 3) Load GeoJSON & Overlay on the Map
    //////////////////////////////////////////////////////////////////
    
    // Store references to each Leaflet layer, keyed by district name
    const districtLayers = {};

    // Load your GeoJSON file
    fetch("output_missouri_filtered.geojson") // <-- replace with your path
      .then(resp => resp.json())
      .then(geoData => {
        // Create a Leaflet GeoJSON layer
        const districtsLayer = L.geoJSON(geoData, {
          style: feature => ({
            color: "black",         // polygon boundary
            weight: 1,              // boundary thickness
            fillColor: "lightgray", // polygon fill
            fillOpacity: 0.6
          }),
          onEachFeature: (feature, layer) => {
            const districtName = feature.properties.NAME;
            
            // Bind a popup (optional)
            layer.bindPopup(`${districtName}`);

            // Store reference to layer for highlighting from chart side
            districtLayers[districtName] = layer;

            // Add mouseover highlight
            layer.on("mouseover", () => {
              layer.setStyle({
                fillColor: "orange",
                fillOpacity: 0.8
              });
            });
            layer.on("mouseout", () => {
              layer.setStyle({
                fillColor: "lightgray",
                fillOpacity: 0.6
              });
            });

            // If user clicks on the polygon, highlight the bar in the chart
            layer.on("click", () => {
              highlightBar(districtName);
            });
          }
        }).addTo(map);

        // Fit map view to the district boundaries
        map.fitBounds(districtsLayer.getBounds());
      });

    //////////////////////////////////////////////////////////////////
    // 4) Cross-Highlight Functions
    //////////////////////////////////////////////////////////////////

    // From bar -> map highlight
    function highlightDistrictOnMap(districtName, highlight) {
      const layer = districtLayers[districtName];
      if (layer) {
        if (highlight) {
          layer.setStyle({
            fillColor: "orange",
            fillOpacity: 0.8
          });
        } else {
          layer.setStyle({
            fillColor: "lightgray",
            fillOpacity: 0.6
          });
        }
      }
    }

    // From map -> chart highlight
    function highlightBar(districtName) {
      // Remove highlight from all bars
      chartGroup.selectAll(".bar").classed("highlighted", false);

      // Highlight the matching bar
      chartGroup.selectAll(".bar")
        .filter(d => d.name === districtName)
        .classed("highlighted", true);

      // Optionally: scroll the bar into view if it's off-screen
      // (you'd need to get the DOM element offset and update #chart.scrollTop)
    }
  </script>
</body>
</html>
